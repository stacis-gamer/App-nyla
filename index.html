<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nyla ðŸ’œ</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  background: #0f0f1a;
  color: #e4e4e7;
  height: 100vh;
  display: flex;
  justify-content: center;
}

/* CHAT CONTAINER */
.chat-container {
  width: 100%;
  max-width: 700px;
  height: 100vh;
  background: #16161f;
  display: flex;
  flex-direction: column;
}

/* HEADER */
.chat-header {
  background: linear-gradient(90deg, #1a1a26, #1f1f33);
  padding: 1rem;
  border-bottom: 1px solid #2a2a3a;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.nyla-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e879f9, #a78bfa);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.status {
  font-size: 0.75rem;
  color: #a78bfa;
}

/* MESSAGES */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.message {
  max-width: 75%;
  padding: 0.75rem 1rem;
  border-radius: 16px;
  animation: popIn 0.25s ease;
  word-wrap: break-word;
}

@keyframes popIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #e879f9, #a78bfa);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.nyla {
  align-self: flex-start;
  background: #1e1e2e;
  border-bottom-left-radius: 4px;
}

.emotion {
  font-size: 0.7rem;
  opacity: 0.6;
  margin-top: 3px;
  color: #a78bfa;
}

/* TYPING */
.typing {
  display: flex;
  gap: 4px;
  padding: 8px 12px;
}

.dot {
  width: 7px;
  height: 7px;
  background: #a78bfa;
  border-radius: 50%;
  animation: bounce 1.4s infinite;
}

.dot:nth-child(2){ animation-delay: .2s }
.dot:nth-child(3){ animation-delay: .4s }

@keyframes bounce {
  0%,80%,100%{ transform: translateY(0); opacity: .6 }
  40%{ transform: translateY(-6px); opacity: 1 }
}

/* INPUT */
.input-area {
  padding: 1rem;
  background: #1a1a26;
  border-top: 1px solid #2a2a3a;
  display: flex;
  gap: 0.5rem;
}

.input-area input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e4e4e7;
}

.input-area button {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #e879f9, #a78bfa);
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="chat-container">
  <div class="chat-header">
    <div class="header-content">
      <div class="nyla-avatar">N</div>
      <div>
        <h2>Nyla</h2>
        <div class="status">online</div>
      </div>
    </div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="input" placeholder="Message Nyla..." />
    <button id="send">âž¤</button>
  </div>
</div>

<script>
/* SUPABASE INIT */
const supabase = window.supabase.createClient(
  "https://sjwwkmjfehsondqbmouu.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqd3drbWpmZWhzb25kcWJtb3V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MzE5MzksImV4cCI6MjA4MTIwNzkzOX0.cgooAxM2BXisi20RH-cKqardpt432dPAs1EI_mVqV0U"
);

/* API */
const API_URL = "https://nyla-api.onrender.com/nyla";

/* DOM */
const messages = document.getElementById("messages");
const input = document.getElementById("input");
const send = document.getElementById("send");

send.onclick = sendMessage;
input.onkeydown = e => e.key === "Enter" && sendMessage();

/* UI */
function addMessage(text, role, emotion=null) {
  const msg = document.createElement("div");
  msg.className = `message ${role}`;
  msg.textContent = text;

  if (emotion) {
    const e = document.createElement("div");
    e.className = "emotion";
    e.textContent = emotion;
    msg.appendChild(e);
  }

  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}

/* TYPING */
let typingEl;
function showTyping() {
  typingEl = document.createElement("div");
  typingEl.className = "message nyla";
  typingEl.innerHTML = `<div class="typing">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>`;
  messages.appendChild(typingEl);
  messages.scrollTop = messages.scrollHeight;
}

function hideTyping() {
  typingEl?.remove();
}

/* LOAD HISTORY */
async function loadHistory() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .order("created_at");

  data?.forEach(m => addMessage(m.content, m.role, m.emotion));
}

/* SEND */
async function sendMessage() {
  if (!input.value.trim()) return;
  const text = input.value;
  input.value = "";

  addMessage(text, "user");
  await supabase.from("messages").insert({ role: "user", content: text });

  showTyping();

  try {
    const r = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });
    const d = await r.json();

    hideTyping();
    addMessage(d.reply, "nyla", d.emotion);

    await supabase.from("messages").insert({
      role: "nyla",
      content: d.reply,
      emotion: d.emotion
    });
  } catch {
    hideTyping();
    addMessage("I glitched ðŸ˜­", "nyla", "shocked");
  }
}

loadHistory();
</script>

</body>
</html>